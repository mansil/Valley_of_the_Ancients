#textdomain wesnoth-Valley_of_the_Ancients

# Dimaga Beach Race!
# Version 1.0.2
# By DanielW (aka.Vincent)
# Copyright under the GNU General Public License (GPL), version 2 and later.

# Special thanks to the wesnoth community for all your help. (Larkle)
# I couldn't have made this map what it is without your support :D

# ------------------------------------------------------
# Achievements!
# Unbreakable: win the race without losing a single unit
# Hardcore: Kill 65 enemies during the race and win # >99
# Capitalist: Finish the race with 75 gold remaining # >60 gold and more gold than average cost of own units
# Blitz: Finish the race in 40 turns or less # depending of max moves of the leader
# ------------------------------------------------------

#define DBR_SPAWN SIDE TYPE X Y WML
    {VARIABLE _x 0}
    {VARIABLE_OP _x add {X}}

    [unit]
        side={SIDE}
        type={TYPE}
        x,y=$_x,{Y}
        generate_name=no
        random_traits=no
        {WML}
    [/unit]

    {VARIABLE _x 34}
    {VARIABLE_OP _x sub {X}}

    [unit]
        side={SIDE}
        type={TYPE}
        x,y=$_x,{Y}
        generate_name=no
        random_traits=no
        {WML}
    [/unit]

    {CLEAR_VARIABLE _x}
#enddef

# Spawning is split into six parts for each side of the path to decease AI turn time
# Our hope is that the player slays them as we create them to keep an balance of AI units
# So we create parts at set intervals via the minimum time the player could get there

#define DBR_SPAWN_A
        {DBR_SPAWN 1 (Troll Whelp) 9 65 ()}
        {DBR_SPAWN 1 (Orcish Grunt) 11 63 ()}
        {DBR_SPAWN 1 (Orcish Grunt) 14 63 ()}
        {DBR_SPAWN 1 (Wolf Rider) 15 62 ()}
        {DBR_SPAWN 1 (Wose) 14 59 ()}
        {DBR_SPAWN 1 (Wose) 12 59 ()}
        {DBR_SPAWN 1 (Elvish Archer) 15 61 ()}
        {DBR_SPAWN 1 (Elvish Fighter) 10 55 ()}
        {DBR_SPAWN 1 (Elvish Fighter) 12 54 ()}
        {DBR_SPAWN 1 (Elvish Archer) 8 56 ()}
        {DBR_SPAWN 1 (Elvish Scout) 8 53 ()}
        {DBR_SPAWN 1 (Dwarvish Guardsman) 7 51 ()}
        {DBR_SPAWN 1 (Dwarvish Guardsman) 5 52 ()}
        {DBR_SPAWN 1 (Orcish Crossbowman) 9 52 ()}
        {DBR_SPAWN 1 (Water Serpent) 9 55 ()}
#enddef

#define DBR_SPAWN_B
        {DBR_SPAWN 1 (Rogue) 4 48 ()}
        {DBR_SPAWN 1 (Gryphon Rider) 6 45 ()}
        {DBR_SPAWN 1 (Ghost) 13 48 ()}
        {DBR_SPAWN 1 (Blood Bat) 12 47 ()}
        {DBR_SPAWN 1 (Giant Spider) 14 47  (
            max_moves=0
            moves=0
        )}
        {DBR_SPAWN 1 (Vampire Bat) 13 47 ()}
        {DBR_SPAWN 1 (Saurian Skirmisher) 5 46 ()}
        {DBR_SPAWN 1 (Dwarvish Thunderer) 3 46 ()}
        {DBR_SPAWN 1 (Bowman) 4 45 ()}
        {DBR_SPAWN 1 (Dark Adept) 7 44 ()}
        {DBR_SPAWN 1 (Dark Adept) 4 43 ()}
        {DBR_SPAWN 1 (Dwarvish Ulfserker) 10 41 ()}
        {DBR_SPAWN 1 (Saurian Skirmisher) 10 42 ()}
        {DBR_SPAWN 1 (Saurian Skirmisher) 8 40 ()}
        {DBR_SPAWN 1 (Merman Fighter) 6 42 ()}
        {DBR_SPAWN 1 (Merman Fighter) 8 41 ()}
        {DBR_SPAWN 1 (Merman Hunter) 10 39 ()}
        {DBR_SPAWN 1 (Ghoul) 8 39 ()}
        {DBR_SPAWN 1 (Skeleton) 7 39 ()}
        {DBR_SPAWN 1 (Skeleton) 7 38 ()}
        {DBR_SPAWN 1 (Dark Adept) 6 36 ()}
        {DBR_SPAWN 1 (Troll Whelp) 10 37 ()}
        {DBR_SPAWN 1 (Troll Whelp) 7 36 ()}
#enddef

#define DBR_SPAWN_C
        {DBR_SPAWN 1 (Giant Scorpion) 13 32 ()}
        {DBR_SPAWN 1 (Goblin Spearman) 11 32 ()}
        {DBR_SPAWN 1 (Goblin Spearman) 10 31 ()}
        {DBR_SPAWN 1 (Goblin Spearman) 8 32 ()}
        {DBR_SPAWN 1 (Goblin Spearman) 13 32 ()}
        {DBR_SPAWN 1 (Goblin Spearman) 13 34 ()}
        {DBR_SPAWN 1 (Orcish Grunt) 14 30 ()}
        {DBR_SPAWN 1 (Orcish Archer) 15 33 ()}
        {DBR_SPAWN 1 (Orcish Archer) 15 32 ()}
        {DBR_SPAWN 1 (Orcish Ruler) 15 31 ()}
        {DBR_SPAWN 1 (Goblin Rouser) 11 31 ()}
        {DBR_SPAWN 1 (Wose) 12 29 ()}
        {DBR_SPAWN 1 (Mage) 11 29 ()}
        {DBR_SPAWN 1 (Wose) 6 31 ()}
        {DBR_SPAWN 1 (Saurian Skirmisher) 2 26 ()}
        {DBR_SPAWN 1 (Saurian Skirmisher) 4 27 ()}
        {DBR_SPAWN 1 (Naga Fighter) 7 26 ()}
        {DBR_SPAWN 1 (Naga Fighter) 7 21 ()}
        {DBR_SPAWN 1 (Ogre) 2 28 ()}
        {DBR_SPAWN 1 (Ogre) 5 28 ()}
        {DBR_SPAWN 1 (Young Ogre) 3 25 ()}
        {DBR_SPAWN 1 (Young Ogre) 4 30 ()}

#enddef

#define DBR_SPAWN_D
        {DBR_SPAWN 1 (Naga Fighter) 6 24 ()}
        {DBR_SPAWN 1 (Dwarvish Berserker) 10 23 ()}
        {DBR_SPAWN 1 (Arch Mage) 10 24 ()}
        {DBR_SPAWN 1 (Arch Mage) 8 23 ()}
        {DBR_SPAWN 1 (Skeleton Archer) 10 18 ()}
        {DBR_SPAWN 1 (Skeleton) 14 18 ()}
        {DBR_SPAWN 1 (Death Knight) 12 18 ()}
        {DBR_SPAWN 1 (Dark Sorcerer) 12 17 ()}
        {DBR_SPAWN 1 (Walking Corpse) 11 18 ()}
        {DBR_SPAWN 1 (Walking Corpse) 11 19 ()}
        {DBR_SPAWN 1 (Walking Corpse) 13 18 ()}
        {DBR_SPAWN 1 (Walking Corpse) 13 19 ()}
#enddef

#define DBR_SPAWN_E
        {DBR_SPAWN 1 (Ancient Wose) 15 12 ()}
        {DBR_SPAWN 1 (Elvish Lady) 13 11 (
            max_moves=0
            moves=0
        )}
        {DBR_SPAWN 1 (Dwarvish Thunderguard) 12 13 ()}
        {DBR_SPAWN 1 (Dwarvish Pathfinder) 12 12 ()}
        {DBR_SPAWN 1 (Dwarvish Pathfinder) 11 14 ()}
        {DBR_SPAWN 1 (Dwarvish Sentinel) 15 14 ()}
        {DBR_SPAWN 1 (Drake Fighter) 16 7 ()}
        {DBR_SPAWN 1 (Naga Warrior) 6 11 ()}
        {DBR_SPAWN 1 (Mermaid Diviner) 10 14 ()}
        {DBR_SPAWN 1 (Cuttle Fish) 9 15 ()}
        {DBR_SPAWN 1 (Elder Mage) 16 14 ()}
        {DBR_SPAWN 1 (Dread Bat) 12 4 ()}
#enddef

[multiplayer]
    id=VOTA_multiplayer_dimagabeachrace
    name= _ "2p â€” Race for Dimaga Beach"
    map_data="{~add-ons/Valley_of_the_Ancients/maps/2p_Dimaga_Beach_Race.map}"
    description= _ "Two players must race down the mountain to dimaga beach! The winner is the player who reaches the end or survives longer than his opponent."
    random_start_time=no

    {DEFAULT_SCHEDULE}
    {SCENARIO_MUSIC breaking_the_chains.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    {EXTRA_SCENARIO_MUSIC the_deep_path.ogg}
    {EXTRA_SCENARIO_MUSIC heroes_rite.ogg}

    # Computer 1 - Defensive (creatures on the path)
    [side]
        side=1
        controller=ai
        recruit=""
        team_name=baddies
        user_team_name= _ "Enemies"
        team_lock=yes
        allow_player=no
        disallow_observers=yes
        [ai]
            # code to make the ai passive until it encounters the players.
            agression=0.9
            caution=0.2
            attack_depth=4
            passive_leader=yes
            {AI_SIMPLE_ALWAYS_ASPECT_VALUE avoid
            (
                [not]
                    radius=1
                    [filter]
                        [not]
                            side=1
                        [/not]
                    [/filter]
                [/not]
            )}
            [goal]
                [criteria]
                    side=2,3
                [/criteria]
                value=1
            [/goal]
        [/ai]
    [/side]

    # Player 1 - The first of the two players
    [side]
        side=2
        canrecruit=yes
        controller=human
        team_name=Contestant
        user_team_name= _ "Contestant (East)"
        team_lock=yes
        fog=yes
        shroud=yes
        shroud_data="{~add-ons/Valley_of_the_Ancients/maps/2p_Dimaga_Beach_Race.shroud}"
        gold=100
    [/side]

    # Player 2 - The second of the two players
    [side]
        side=3
        canrecruit=yes
        controller=human
        team_name=Contestant
        user_team_name= _ "Contestant (West)"
        team_lock=yes
        fog=yes
        shroud=yes
        shroud_data="{~add-ons/Valley_of_the_Ancients/maps/2p_Dimaga_Beach_Race.shroud}"
        gold=100
    [/side]

    # Computer 2 - Aggressive (the shadows)
    [side]
        side=4
        canrecruit=yes
        recruit=""
        controller=ai
        team_name=baddies
        team_lock=yes
        hidden=yes
        allow_player=no
        disallow_observers=yes
        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            passive_leader=yes
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 4 main_loop villages}
        [/ai]
    [/side]

    # Populate the map with the items required
    {PLACE_IMAGE scenery/signpost.png 17 7}

    # goodies for the Bat Cave!
    {PLACE_IMAGE items/ring-red.png 14 47}
    {PLACE_IMAGE items/ring-gold.png 20 47}

    # Label items to assist players!
    [label]
        x,y=17,7
        text= _ "Dimaga Beach"
    [/label]

    [event]
        name=prestart

        # Set the scenario objectives for the players
        [objectives]
            side=0
            [objective]
                description= _ "Advance your leader to Dimaga Beach"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of your Leader"
                condition=lose
            [/objective]
            [objective]
                description= _ "Opponent's Leader reaches Dimaga Beach"
                condition=lose
            [/objective]
        [/objectives]

        [store_unit]
            [filter]
                side=1
                type=Elder Mage
            [/filter]
            variable=mages
        [/store_unit]

        {FOREACH mages i}
            [object]
                silent=yes
                [filter]
                    id=$mages[$i].id
                [/filter]

                [effect]
                    apply_to=attack
                    range=ranged
                    increase_attacks=28
                    increase_damage=-12
                    set_type=arcane
                [/effect]

                [effect]
                    apply_to=attack
                    range=melee
                    increase_attacks=1
                    increase_damage=16
                    set_type=cold
                [/effect]

                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_SKIRMISHER}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase=62
                    increase_total=62
                [/effect]
                [effect]
                    apply_to=max_experience
                    increase=900
                [/effect]
            [/object]
        {NEXT i}

        {CLEAR_VARIABLE mages}
    [/event]

    [event]
        name=start

        # Create two enemies at start
        {DBR_SPAWN 1 (Troll Whelp) 11 65 (
            [modifications]
                {TRAIT_FEARLESS}
            [/modifications]
        )}

        # Dimaga speaks to players
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Ah, greetings contestants and welcome to 'The race for Dimaga Beach!'"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Your quest is simple, proceed north..."
        [/message]

        # Scroll to Dimaga beach sign post
        [scroll_to]
            x,y=17,7
            check_fogged=false
        [/scroll_to]

        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "...to Dimaga Beach before your opponent gets there."
        [/message]
        [scroll_to]
            x,y=17,48
            check_fogged=false
        [/scroll_to]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "These rings grant one lucky unit, for each player, a melee enhancement."
        [/message]
        [scroll_to]
            x,y=17,67
            check_fogged=false
        [/scroll_to]

        # move the starting hostiles into sight
        {MOVE_UNIT (x,y=11,65) 11 67}
        {MOVE_UNIT (x,y=23,65) 23 67}

        [scroll_to]
            x,y=11,67
            check_fogged=false
        [/scroll_to]

        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Hostile creatures scatter the path! You must be fast and efficient."
        [/message]
        [scroll_to]
            x,y=17,73
            check_fogged=false
        [/scroll_to]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "If you are killed then your opponent is immediately victorious."
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Your keep will disappear on turn 10 so choose your units wisely."
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Be sure to thank Vincent for his awesome work!"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Now let the Race begin!"
        [/message]
    [/event]

    # record the death of a creature
    [event]
        name=last breath
        first_time_only=no
        {VARIABLE_OP kills$second_unit.side add 1}
    [/event]

    # Our spawning sequence to spawn groups of creatures as players progress
    [event]
        name=turn 1
        {DBR_SPAWN_A}
    [/event]

    [event]
        name=moveto
        
        [filter]
            side=2,3
            x,y=1-33,1-56
        [/filter]
        {DBR_SPAWN_B}
    [/event]

    [event]
        name=moveto
        
        [filter]
            side=2,3
            x,y=1-33,1-46
        [/filter]
        {DBR_SPAWN_C}
    [/event]

    [event]
        name=moveto
        
        [filter]
            side=2,3
            x,y=1-33,1-34
        [/filter]
        {DBR_SPAWN_D}
    [/event]

    [event]
        name=moveto
        
        [filter]
            side=2,3
            x,y=1-33,1-24
        [/filter]

        {DBR_SPAWN_E}
        {NOTRAIT_UNIT 1 (Grand Marshal) 17 12} # spawned for both left and right
        {NOTRAIT_UNIT 1 (Fire Dragon) 17 7} # spawned for both left and right
    [/event]

    # Spawn side 4 enemies behind the players
    [event]
        name=new turn
        first_time_only=no

        [filter_condition]
            {VARIABLE_CONDITIONAL turn_number greater_than 30}
        [/filter_condition]

        {VARIABLE bats $turn_number}
        {VARIABLE_OP bats modulo 3}

        {VARIABLE shadows $turn_number}
        {VARIABLE_OP shadows modulo 8}

        {VARIABLE drakes $turn_number}
        {VARIABLE_OP drakes modulo 7}

        [if]
            {VARIABLE_CONDITIONAL bats equals 0}
            [and]
                [have_unit]
                    race=bat
                    side=4
                    canrecruit=no
                    count=0-1
                [/have_unit]
            [/and]
            [then]
                [while]
                    {VARIABLE_CONDITIONAL number less_than 4}
                    [do]
                        {DBR_SPAWN 4 (Dread Bat) 6 43 (
                            [modifications]
                                {TRAIT_QUICK}
                            [/modifications]
                        )}
                        {VARIABLE_OP number add 1}
                    [/do]
                [/while]
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL shadows equals 0}
            [and]
                [have_unit]
                    race=undead
                    side=4
                    canrecruit=no
                    count=0-1
                [/have_unit]
            [/and]
            [then]
                [while]
                    {VARIABLE_CONDITIONAL number less_than 3}
                    [do]
                        {DBR_SPAWN 4 (Shadow) 8 55 (
                            [modifications]
                                {TRAIT_QUICK}
                            [/modifications]
                        )}
                        {VARIABLE_OP number add 1}
                    [/do]
                [/while]
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL drakes equals 0}
            [and]
                [have_unit]
                    race=drake
                    side=4
                    canrecruit=no
                    count=0-2
                [/have_unit]
            [/and]
            [then]
                [while]
                    {VARIABLE_CONDITIONAL number less_than 3}
                    [do]
                        {DBR_SPAWN 4 (Sky Drake) 7 47 (
                            [modifications]
                                {TRAIT_QUICK}
                            [/modifications]
                        )}
                        {VARIABLE_OP number add 1}
                    [/do]
                [/while]
            [/then]
        [/if]
    [/event]

    # Remove the keep on turn 10
    [event]
        name=turn 10

        # play a sound effect
        [sound]
            name=rumble.ogg
        [/sound]

        # remove keep
        [terrain]
            [and]
                terrain=Ket
            [/and]
            terrain=Re
        [/terrain]
    [/event]

    # Whoa, I'm amazed that you've bothered to read these notes...

    # Player 1 grabs the "Ring of Fire"
    [event]
        name=moveto

        [filter]
            side=2
            x,y=14,47
        [/filter]

        [sound]
            name=magic-holy-1.ogg
        [/sound]

        [object]
            id=FlameRing
            name= _ "Ring of Fire"
            image=items/ring-red.png
            description= _ "This enchanted ring has made your melee weapon burn and deal 25% extra damage!"
            [effect]
                apply_to=attack
                #range=melee
                set_type=fire
            [/effect]
            [effect]
                apply_to=attack
                #range=melee
                increase_damage=25%
            [/effect]
        [/object]
        [remove_item]
            x,y=14,47
        [/remove_item]
    [/event]

    # Player 2 grabs the "Ring of Accuracy"
    [event]
        name=moveto

        [filter]
            side=3
            x,y=20,47
        [/filter]

        [sound]
            name=magic-holy-1.ogg
        [/sound]

        [object]
            id=AccuracyRing
            name= _ "Ring of Accuracy"
            image=items/ring-gold.png
            description= _ "This ring has enchanted your melee weapon and granted it 70% accuracy!"
            [effect]
                apply_to=attack
                #range=melee
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_MAGICAL}
                [/set_specials]
            [/effect]
        [/object]
        [remove_item]
            x,y=20,47
        [/remove_item]
    [/event]

    # If a player makes it to the final league, and his opponent is still alive, they must fight for the win.
    [event]
        name=moveto

        [filter]
            side=3,4
            x,y=1-33,1-20
        [/filter]

        [modify_side]
            side=2
            team_name=left
        [/modify_side]

        [modify_side]
            side=3
            team_name=right
        [/modify_side]

        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Attention players!"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Vision of your opponent has been removed, you must fight for the Win."
        [/message]
    [/event]

    # Death of human side unit in battle.
    [event]
        name=die
        [filter]
            side=2,3
            canrecruit=no
        [/filter]
        [set_variable]
            name=Player$unit.side|loss
            value=yes
        [/set_variable]
    [/event]

    # Player 1 lets himself die and is thus disqualified
    [event]
        name=die

        [filter]
            side=2,3
            canrecruit=yes
        [/filter]

        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "$unit.name has been slain..."
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Therefore his opponent is Victorious! Congratulations!"
        [/message]
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Thanks for playing and please come again!"
        [/message]

        [modify_side]
            side=2
            team_name=left
        [/modify_side]

        [modify_side]
            side=3
            team_name=right
        [/modify_side]

        [kill]
            side=1,4
            canrecruit=yes
        [/kill]
    [/event]

    # A Player reaches the signpost thus wins the race
    [event]
        name=moveto
        first_time_only=yes

        [filter]
            side=2,3
            canrecruit=yes
            x,y=17,7
        [/filter]

        # Victory message for the winner!
        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Ladies and gentlemen, we have a Winner."
        [/message]
        [message]
            speaker=narrator
            caption=Dimaga Entruse
            image=portraits/humans/duelist.png
            message= _ "Congratulations $unit.name!"
        [/message]

        # Unbreakable Achievement!
        [if]
            {VARIABLE_CONDITIONAL Player$unit.side|loss not_equals yes}
            [then]
                [message]
                    speaker=narrator
                    caption= _ "Unbreakable Achievement"
                    image=portraits/humans/transparent/halberdier.png
                    message= _ "$unit.name has not lost a single unit in the race!"
                [/message]
            [/then]
        [/if]

        # Hardcore achievement
        [if]
            # there are ~80 side 1 units on the path + side 4
            # this requires a player to kill everything/take a detour south the opponent branch
            {VARIABLE_CONDITIONAL kills$unit_side greater_than 99}
            [then]
                [message]
                    speaker=narrator
                    caption= _ "Hardcore Achievement"
                    image=portraits/humans/transparent/iron-mauler.png
                    message= _ "$unit.name has killed $kills$unit_side units during the race!"
                [/message]
            [/then]
        [/if]

        # Blitz Achievement!
        {VARIABLE required_turns "$(((72-8)/$unit.max_moves)*3)"} # distance divided by leaders max moves plus some turns for fight/heal/rought terrain
        {VARIABLE_OP required_turns round ceil} # evaluates to 48, 39, 32, 28, 24 turns for leaders with 4, 5, 6, 7 and 8 respectively

        [if]
            {VARIABLE_CONDITIONAL turn_number less_than_equal_to $required_turns}
            [then]
                [message]
                    speaker=narrator
                    caption= _ "Blitz Achievement"
                    image=portraits/humans/transparent/knight.png
                    message= _ "$unit.name has completed the race in $turn_number turns!"
                [/message]
            [/then]
        [/if]

        # Capitalist Achievement!
        [store_gold]
            side=$unit.side
        [/store_gold]

        [store_unit]
            [filter]
                side=$unit.side
                canrecruit=no
            [/filter]
            variable=army
        [/store_unit]

        {FOREACH army i}
            {VARIABLE_OP army_cost add $army[$i].cost}
        {NEXT i}

        {VARIABLE_OP army_cost divide $army.length}

        [if]
            {VARIABLE_CONDITIONAL gold greater_than $army_cost}
            {VARIABLE_CONDITIONAL gold greater_than 60}
            [then]
                [message]
                    speaker=narrator
                    caption= _ "Capitalist Achievement"
                    image=portraits/humans/transparent/general.png
                    message= _ "$unit.name has finished the race with $gold gold to spare!"
                [/message]
            [/then]
        [/if]

        [message]
            speaker=narrator
            caption= _ "Dimaga Entruse"
            image=portraits/humans/transparent/duelist.png
            message= _ "Thanks for playing and please come again!"
        [/message]

        [kill]
            [not]
                side=$unit.side
            [/not]
            canrecruit=yes
        [/kill]

        {CLEAR_VARIABLE gold,army,army_cost,required_turns,kills2,kills3,Player2loss,Player3loss}
    [/event]
[/multiplayer]

#undef DBR_SPAWN
#undef DBR_SPAWN_A
#undef DBR_SPAWN_B
#undef DBR_SPAWN_C
#undef DBR_SPAWN_D
#undef DBR_SPAWN_E
